# Rakefile for rhales-roda-demo

# Load Rhales rake tasks for schema generation
# Note: In a real project, these would be loaded from the gem
# For this demo, we load from the local gem directory
begin
  # Try loading from local gem development directory
  rake_tasks = File.expand_path('../../lib/tasks/rhales_schema.rake', __dir__)
  load rake_tasks if File.exist?(rake_tasks)
rescue LoadError
  # Fallback: load from installed gem
  spec = Gem::Specification.find_by_name('rhales')
  load "#{spec.gem_dir}/lib/tasks/rhales_schema.rake"
end

desc 'Run CI integration test (replicates GitHub Actions workflow)'
task :ci_test do
  puts "Installing demo dependencies..."
  system('bundle install') || (puts "Failed to install dependencies" && exit(1))

  puts "Starting demo server..."
  server_pid = spawn('bundle exec rackup -p 9393')
  puts "Server PID: #{server_pid}"

  begin
    # Wait for server to start
    sleep 1

    # Test the server (replicates: curl -f http://localhost:9393/ || exit 1)
    puts "Testing demo server..."
    success = system('curl -f http://localhost:9393/')
    puts "Curl exit status: #{$?.exitstatus}"

    if success
      puts "✓ Demo integration test passed"
    else
      puts "✗ Demo integration test failed"
      exit 1
    end
  ensure
    # Clean up (replicates: pkill -f rackup || true)
    if server_pid
      Process.kill('TERM', server_pid) rescue nil
      Process.wait(server_pid) rescue nil
    end
  end
end

task default: :ci_test
